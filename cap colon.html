<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAP Colorectal Resection Protocol 4.4.0.1</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; max-width: 900px; line-height: 1.6; }
        h1 { color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; }
        h2 { background-color: #f0f4f8; padding: 10px; border-left: 5px solid #3498db; margin-top: 30px; }
        h3 { color: #2980b9; margin-top: 20px; font-size: 1.1em; }
        .question-block { margin-bottom: 15px; padding: 10px; border: 1px solid #eee; border-radius: 4px; }
        .question-label { font-weight: bold; display: block; margin-bottom: 5px; }
        .sub-question {margin-left: 30px; padding: 10px;border-left: 2px solid #ccc;background-color: #f9f9f9;margin-top: 5px;}
        label { display: block; margin-bottom: 5px; cursor: pointer; }
        input[type="text"], input[type="number"] { padding: 5px; width:auto; margin-left: 10px; }
        .synoptic-container { background-color: #e8f6f3; padding: 20px; border: 2px solid #1abc9c; margin-top: 40px; border-radius: 8px; }
        .synoptic-title { font-size: 1.5em; font-weight: bold; color: #16a085; margin-bottom: 15px; }
        ul.synoptic-list { list-style-type: disc; padding-left: 20px; }
        li.synoptic-item { margin-bottom: 5px; font-family: 'Courier New', Courier, monospace; }
        .note { font-size: 0.85em; color: #666; font-style: italic; }
    </style>
</head>
<body>

    <h1>CAP Protocol: Colon and Rectum Resection (v4.4.0.1)</h1>
    <p><em>Based on AJCC 8th Edition</em></p>

    <form id="capForm">

        <h2>Specimen</h2>
        
        <div class="question-block">
            <span class="question-label">Organ</span>
            <label><input type="checkbox" name="Specimen" value="Ileum" data-label="Specimen"> Ileum</label>
            <label><input type="checkbox" name="Specimen" value="Appendix" data-label="Specimen"> Appendix</label>
            <label><input type="checkbox" name="Specimen" value="Cecum" data-label="Specimen"> Cecum</label>
            <label><input type="checkbox" name="Specimen" value="Ascending colon" data-label="Specimen"> Ascending colon</label>
            <label><input type="checkbox" name="Specimen" value="Transverse colon" data-label="Specimen"> Transverse colon</label>
            <label><input type="checkbox" name="Specimen" value="Descending colon" data-label="Specimen"> Descending colon</label>
            <label><input type="checkbox" name="Specimen" value="Sigmoid colon" data-label="Specimen"> Sigmoid colon</label>
            <label><input type="checkbox" name="Specimen" value="Rectosigmoid" data-label="Specimen"> Rectosigmoid</label>
            <label><input type="checkbox" name="Specimen" value="Rectum" data-label="Specimen" onclick="toggleSub('Rectum tumor only', this.checked)"> Rectum</label>   
                <div id="rectum-part" class="sub-question" style="display: true;">
                    <label><input type="checkbox" name="Specimen" value="Upper rectum" data-label="Specimen" onclick="toggleSub('Rectum tumor only', this.checked)"> Upper rectum</label>
                    <label><input type="checkbox" name="Specimen" value="Middle rectum" data-label="Specimen" onclick="toggleSub('Rectum tumor only', this.checked)"> Middle rectum</label>
                    <label><input type="checkbox" name="Specimen" value="Lower rectum" data-label="Specimen" onclick="toggleSub('Rectum tumor only', this.checked)"> Lower rectum</label>
                </div>
            <label><input type="checkbox" name="Specimen" value="Omentum" data-label="Specimen"> Omentum</label>
            <label><input type="checkbox" name="Specimen" value="Other" data-label="Specimen" class="has-text"> Other<input type="text" name="organ-other"></label>
        </div>
        
              
        <h2>Tumor</h2>
        <div class="question-block">
            <span class="question-label">Histologic Type</span>
            <label><input type="radio" name="Histology" value="Adenocarcinoma" data-label="Histologic Type" onclick="resetOtherInputs(this)"> Adenocarcinoma</label>
            <label><input type="radio" name="Histology" value="Mucinous adenocarcinoma" data-label="Histologic Type" onclick="resetOtherInputs(this)"> Mucinous adenocarcinoma</label>
            <label><input type="radio" name="Histology" value="Poorly cohesive carcinoma" data-label="Histologic Type" onclick="resetOtherInputs(this)"> Poorly cohesive carcinoma</label>
            <label><input type="radio" name="Histology" value="Signet-ring cell carcinoma" data-label="Histologic Type" onclick="resetOtherInputs(this)"> Signet-ring cell carcinoma</label>
            <label><input type="radio" name="Histology" value="Medullary carcinoma" data-label="Histologic Type" onclick="resetOtherInputs(this)"> Medullary carcinoma</label>
            <label><input type="radio" name="Histology" value="Serrated adenocarcinoma" data-label="Histologic Type" onclick="resetOtherInputs(this)"> Serrated adenocarcinoma</label>
            <label><input type="radio" name="Histology" value="Micropapillary adenocarcinoma" data-label="Histologic Type" onclick="resetOtherInputs(this)"> Micropapillary adenocarcinoma</label>
            <label><input type="radio" name="Histology" value="Adenoma-like adenocarcinoma" data-label="Histologic Type" onclick="resetOtherInputs(this)"> Adenoma-like adenocarcinoma</label>
            <label><input type="radio" name="Histology" value="Adenosquamous carcinoma" data-label="Histologic Type" onclick="resetOtherInputs(this)"> Adenosquamous carcinoma</label>
            <label><input type="radio" name="Histology" value="Undifferentiated carcinoma, NOS" data-label="Histologic Type" onclick="resetOtherInputs(this)"> Undifferentiated carcinoma, NOS</label>
            <label><input type="radio" name="Histology" value="Carcinoma with sarcomatoid component" data-label="Histologic Type" onclick="resetOtherInputs(this)"> Carcinoma with sarcomatoid component</label>
            <label><input type="radio" name="Histology" value="Large cell neuroendocrine carcinoma" data-label="Histologic Type" onclick="resetOtherInputs(this)"> Large cell neuroendocrine carcinoma</label>
            <label><input type="radio" name="Histology" value="Small cell neuroendocrine carcinoma" data-label="Histologic Type" onclick="resetOtherInputs(this)"> Small cell neuroendocrine carcinoma</label>
            <label><input type="radio" name="Histology" value="Other" data-label="Histologic Type" class="has-text"> Other: <input type="text" name="Histology_Other"></label>
        </div>

        <div class="question-block">
            <span class="question-label">Histologic Grade</span>
            <label><input type="radio" name="Grade" value="G1, well-differentiated" data-label="Histologic Grade"> G1, well-differentiated</label>
            <label><input type="radio" name="Grade" value="G2, moderately differentiated" data-label="Histologic Grade"> G2, moderately differentiated</label>
            <label><input type="radio" name="Grade" value="G3, poorly differentiated" data-label="Histologic Grade"> G3, poorly differentiated</label>
            <label><input type="radio" name="Grade" value="G4, undifferentiated" data-label="Histologic Grade"> G4, undifferentiated</label>
            <label><input type="radio" name="Grade" value="GX, cannot be assessed" data-label="Histologic Grade"> GX, cannot be assessed</label>
        </div>

        <div class="question-block">
            <span class="question-label">Tumor Size</span>
            <label><input type="radio" name="TumorSizeCheck" value="sizeAvailable" data-label="Tumor Size"> in cm =<input type="text" name="TumorSize" data-label="Tumor Size (cm)"></label>
            <label><input type="radio" name="TumorSizeCheck" value="Cannot be determined" data-label="Tumor Size" onclick="resetOtherInputs(this)"> Cannot be determined</label>
        </div>

        <div class="question-block">
            <span class="question-label">Tumor Site (Select all that apply)</span>
            <label><input type="checkbox" name="TumorSite" value="Cecum" data-label="Tumor Site"> Cecum</label>
            <label><input type="checkbox" name="TumorSite" value="Ileocecal valve" data-label="Tumor Site"> Ileocecal valve</label>
            <label><input type="checkbox" name="TumorSite" value="Ascending colon" data-label="Tumor Site"> Ascending colon</label>
            <label><input type="checkbox" name="TumorSite" value="Hepatic flexure" data-label="Tumor Site"> Hepatic flexure</label>
            <label><input type="checkbox" name="TumorSite" value="Transverse colon" data-label="Tumor Site"> Transverse colon</label>
            <label><input type="checkbox" name="TumorSite" value="Splenic flexure" data-label="Tumor Site"> Splenic flexure</label>
            <label><input type="checkbox" name="TumorSite" value="Descending colon" data-label="Tumor Site"> Descending colon</label>
            <label><input type="checkbox" name="TumorSite" value="Sigmoid colon" data-label="Tumor Site"> Sigmoid colon</label>
            <label><input type="checkbox" name="TumorSite" value="Rectosigmoid" data-label="Tumor Site"> Rectosigmoid</label>
            <label><input type="checkbox" name="TumorSite" value="Rectum" data-label="Tumor Site"> Rectum</label>
            <label><input type="checkbox" name="TumorSite" value="Colon, NOS" data-label="Tumor Site"> Colon, NOS</label>
        </div>

        <div id="Rectum tumor only" class="question-block" style="display: none;">
        <h2>Rectal tumor only</h2>
            <span class="question-label">Macroscopic Evaluation of Mesorectum</span>
            <label><input type="radio" name="Mesorectum" value="Not applicable" data-label="Mesorectum Evaluation"> Not applicable</label>
            <label><input type="radio" name="Mesorectum" value="Complete" data-label="Mesorectum Evaluation"> Complete</label>
            <label><input type="radio" name="Mesorectum" value="Near complete" data-label="Mesorectum Evaluation"> Near complete</label>
            <label><input type="radio" name="Mesorectum" value="Incomplete" data-label="Mesorectum Evaluation"> Incomplete</label>
            <label><input type="radio" name="Mesorectum" value="Cannot be determined" data-label="Mesorectum Evaluation"> Cannot be determined</label>

            <span class="question-label">Rectal Tumor Location</span>
            <label><input type="radio" name="RectalLocation" value="Entirely above anterior peritoneal reflection" data-label="Rectal Tumor Location"> Entirely above anterior peritoneal reflection</label>
            <label><input type="radio" name="RectalLocation" value="Entirely below anterior peritoneal reflection" data-label="Rectal Tumor Location"> Entirely below anterior peritoneal reflection</label>
            <label><input type="radio" name="RectalLocation" value="Straddles anterior peritoneal reflection" data-label="Rectal Tumor Location"> Straddles anterior peritoneal reflection</label>
            <label><input type="radio" name="RectalLocation" value="Not specified" data-label="Rectal Tumor Location"> Not specified</label>
        </div>
      

        <div class="question-block">
            <span class="question-label">Tumor Extent</span>
            <label><input type="radio" name="Extent" value="No invasion (high-grade dysplasia)" data-label="Tumor Extent" onclick="resetOtherInputs(this)"> No invasion (high-grade dysplasia)</label>
            <label><input type="radio" name="Extent" value="Invades submucosa" data-label="Tumor Extent" onclick="resetOtherInputs(this)"> Invades submucosa</label>
            <label><input type="radio" name="Extent" value="Invades into muscularis propria" data-label="Tumor Extent" onclick="resetOtherInputs(this)"> Invades into muscularis propria</label>
            <label><input type="radio" name="Extent" value="Invades through muscularis propria into pericolic/perirectal tissue" data-label="Tumor Extent" onclick="resetOtherInputs(this)"> Invades through muscularis propria into pericolic/perirectal tissue</label>
            <label><input type="radio" name="Extent" value="Invades visceral peritoneum" data-label="Tumor Extent" onclick="resetOtherInputs(this)"> Invades visceral peritoneum (including tumor continuous with serosal surface through area of
inflammation)</label>
            <label><input type="radio" name="Extent" value="Directly invades adjacent structure(s)" data-label="Tumor Extent" class="has-text"> Directly invades adjacent structure(s): <input type="text" name="Extent_Structure"></label>
            <label><input type="radio" name="Extent" value="Cannot be determined" data-label="Tumor Extent" onclick="resetOtherInputs(this)"> Cannot be determined</label>
        </div>

        <div class="question-block">
            <span class="question-label">Macroscopic Tumor Perforation</span>
            <label><input type="radio" name="Perforation" value="Not identified" data-label="Macroscopic Tumor Perforation"> Not identified</label>
            <label><input type="radio" name="Perforation" value="Present" data-label="Macroscopic Tumor Perforation"> Present</label>
            <label><input type="radio" name="Perforation" value="Cannot be determined" data-label="Macroscopic Tumor Perforation"> Cannot be determined</label>
        </div>

        <div class="question-block">
            <span class="question-label">Lymphatic and/or Vascular Invasion (LVI)</span>
            <label><input type="radio" name="LVI" value="Not identified" data-label="Lymphovascular invasion" onclick="toggleSub('lvi-details', false)">Not identified</label>
            <label><input type="radio" name="LVI" value="Present" data-label="Lymphovascular invasion" onclick="toggleSub('lvi-details', true)">Present</label>
                <div id="lvi-details" class="sub-question" style="display: none;">
                    <label><input type="checkbox" name="LVI" value="Small vessel" data-label="Lymphovascular invasion"> Small vessel</label>
                    <label><input type="checkbox" name="LVI" value="Large vessel, intramural" data-label="Lymphovascular invasion"> Large vessel, intramural</label>
                    <label><input type="checkbox" name="LVI" value="Large vessel, extramural" data-label="Lymphovascular invasion"> Large vessel, extramural</label>
                </div>
        </div>

        <div class="question-block">
            <span class="question-label">Perineural Invasion</span>
            <label><input type="radio" name="PNI" value="Not identified" data-label="Perineural Invasion" onclick="resetOtherInputs(this)"> Not identified</label>
            <label><input type="radio" name="PNI" value="Present" data-label="Perineural Invasion" onclick="resetOtherInputs(this)"> Present</label>
        </div>

        <div class="question-block">
            <span class="question-label">Treatment Effect</span>
            <label><input type="radio" name="TreatmentEffect" value="No known presurgical therapy" data-label="Treatment Effect"> No known presurgical therapy</label>
            <label><input type="radio" name="TreatmentEffect" value="Score 0 (Complete Response)" data-label="Treatment Effect"> Score 0 (Complete Response)</label>
            <label><input type="radio" name="TreatmentEffect" value="Score 1 (Near Complete Response)" data-label="Treatment Effect"> Score 1 (Near Complete Response)</label>
            <label><input type="radio" name="TreatmentEffect" value="Score 2 (Partial Response)" data-label="Treatment Effect"> Score 2 (Partial Response)</label>
            <label><input type="radio" name="TreatmentEffect" value="Score 3 (Poor/No Response)" data-label="Treatment Effect"> Score 3 (Poor/No Response)</label>
        </div>

        <h2>Margins</h2>

        <div class="question-block">
            <label><input type="radio" name="MarginStatus" value="All margins negative" data-label="Margin Status" onclick="toggleSub('Negative_margin', true); resetOtherInputs(this)"> All margins negative for invasive carcinoma</label>
                <div id="Negative_margin" class="sub-question" style ="display: none;">
                    <span class="question-label">Closest Margin(s) to Invasive Carcinoma</span>
                        <label><input type="checkbox" name="ClosestMargin" value="Proximal" data-label="Closest Margin"> Proximal</label>
                        <label><input type="checkbox" name="ClosestMargin" value="Distal" data-label="Closest Margin"> Distal</label>
                        <label><input type="checkbox" name="ClosestMargin" value="Radial" data-label="Closest Margin"> Radial</label>
                        <label><input type="checkbox" name="ClosestMargin" value="Mesenteric" data-label="Closest Margin"> Mesenteric</label>
                        <label><input type="checkbox" name="ClosestMargin" value="Other" data-label="Closest Margin" class="has-text"> Other <input type="text" name="Closest Margin"></label>
                    
                    <span class="question-label">Distance to Closest Margin</span>
                        <label>cm: <input type="text" name="MarginDistance" data-label="Distance to Closest Margin"></label>
                </div>
            <label class="has-text"><input type="radio" name="MarginStatus" value="Invasive carcinoma present at margin" data-label="Margin Status" class="has-text" onclick="toggleSub('Negative_margin', false)"> Invasive carcinoma present at<input type="text" name="Positive margin"> margin</label>
        </div>

        

        <h2>Regional Lymph Nodes</h2>
        <div class="question-block">
            <span class="question-label">Regional Lymph Node Status</span>
            <label>
                <input type="radio" name="LN_Radio" data-label="Lymph node metastasis" id="ln_ratio_radio">
                <input type="text" id="ln_meta" name="LNStatus_Meta" placeholder="Positive" size="3" oninput="calculatePN()"> / 
                <input type="text" id="ln_total" name="LNStatus_Total" placeholder="Total" size="3">
            </label>
            <label>
                <input type="radio" name="LN_Radio" value="Not applicable" data-label="Lymph node metastasis" onclick="resetOtherInputs(this)"> Not applicable
            </label>
        </div>

        <div class="question-block">
            <span class="question-label">Tumor Deposits</span>
            <label><input type="radio" name="TumorDeposits" value="Not identified" data-label="Tumor Deposits"onclick="resetOtherInputs(this)"> Not identified</label>
            <label><input type="radio" name="TumorDeposits" value="Present" data-label="Tumor Deposits" class="has-text"> Present<input type="text" name="TumorDepositsNum" placeholder="Specify number" size="9"></label>
        </div>


        <h2>Additional Findings</h2>
        <div class="question-block">
            <span class="question-label">Select all that apply</span>
            <label><input type="checkbox" name="AddFindings" value="Adenoma(s)" data-label="Additional Findings">Lymphoid hyperplasia of the appendix</label>
            <label><input type="checkbox" name="AddFindings" value="Ulcerative colitis" data-label="Additional Findings">Chronic colitis</label>
            <label><input type="checkbox" name="AddFindings" value="Crohn disease" data-label="Additional Findings">Ischemic colitis</label>
            <label><input type="checkbox" name="AddFindings" value="Diverticulosis" data-label="Additional Findings">Acute peritonitis</label>
            <label><input type="checkbox" name="AddFindings" value="Other" data-label="Additional Findings" class="has-text"> Other <input type="text" name="Other"></label>
        </div>

        
        <h2>pTNM Classification (AJCC 8th Ed)</h2>
        <div class="question-block">
            <span class="question-label">Prefix/Suffix</span>
            <label><input type="checkbox" name="prefix" value="y" data-label="y_post treatment">y (post treatment)</label>
            <label><input type="checkbox" name="prefix" value="r" data-label="r_recurrent">r (recurrent)</label>
            <label><input type="checkbox" name="suffix" value="m" data-label="m_multiple">m (multiple primary)</label>
        </div>
        
        <div class="question-block">
            <span class="question-label">pT Category</span>
            <label><input type="radio" name="pT" value="pT0: No evidence of primary tumor" data-label="pT Category"> pT0: No evidence of primary tumor</label>
            <label><input type="radio" name="pT" value="pTis: Carcinoma in situ" data-label="pT Category"> pTis: Carcinoma in situ</label>
            <label><input type="radio" name="pT" value="pT1: Invades submucosa" data-label="pT Category"> pT1: Invades submucosa</label>
            <label><input type="radio" name="pT" value="pT2: Invades muscularis propria" data-label="pT Category"> pT2: Invades muscularis propria</label>
            <label><input type="radio" name="pT" value="pT3: Invades through muscularis propria" data-label="pT Category"> pT3: Invades through muscularis propria</label>
            <label><input type="radio" name="pT" value="pT4a: Invades visceral peritoneum" data-label="pT Category"> pT4a: Invades visceral peritoneum</label>
            <label><input type="radio" name="pT" value="pT4b: Directly invades adjacent organs" data-label="pT Category"> pT4b: Directly invades adjacent organs</label>
        </div>

        <div class="question-block" id="pn-category-section">
            <span class="question-label">pN Category</span>
            <label><input type="radio" name="pN" id = "pN0" value="pN0: No regional LN metastasis" data-label="pN Category"> pN0: No regional LN metastasis</label>
            <label><input type="radio" name="pN" id = "pN1a" value="pN1a: 1 positive node" data-label="pN Category"> pN1a: 1+ve node</label>
            <label><input type="radio" name="pN" id = "pN1b" value="pN1b: 2-3 positive nodes" data-label="pN Category"> pN1b: 2-3+ve nodes</label>
            <label><input type="radio" name="pN" id = "pN1c" value="pN1c: Tumor deposits only (no LN+)" data-label="pN Category"> pN1c: Tumor deposits only (no LN+)</label>
            <label><input type="radio" name="pN" id = "pN2a" value="pN2a: 4-6 positive nodes" data-label="pN Category"> pN2a: 4-6 +ve nodes</label>
            <label><input type="radio" name="pN" id = "pN2b" value="pN2b: 7 or more positive nodes" data-label="pN Category"> pN2b: >= 7 +ve nodes</label>
            <label><input type="radio" name="pN" value="Not applicable / Cannot be determined" data-label="pN Category"> Not applicable / Cannot be determined</label>
        </div>

        <div class="question-block">
            <span class="question-label">pM Category</span>
            <label><input type="radio" name="pM" value="Not applicable / Cannot be determined" data-label="pM Category"> Not applicable / Cannot be determined</label>
            <label><input type="radio" name="pM" value="pM1a: Metastasis to one site" data-label="pM Category"> pM1a: Metastasis to one site</label>
            <label><input type="radio" name="pM" value="pM1b: Metastasis to 2+ sites" data-label="pM Category"> pM1b: Metastasis to 2+ sites</label>
            <label><input type="radio" name="pM" value="pM1c: Peritoneal metastasis" data-label="pM Category"> pM1c: Peritoneal metastasis</label>
        </div>

        

    </form>

    <div class="synoptic-container">
        <div class="synoptic-title">Synoptic Report</div>
        <ul id="synopticList" class="synoptic-list">
            <li class="synoptic-item">Please select options above to generate the report.</li>
        </ul>
    </div>

    <script>
        function toggleSub(containerId, show) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.style.display = show ? 'block' : 'none';
            if (!show) {
                const subInputs = container.querySelectorAll('input');
                subInputs.forEach(input => {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
            }
        }

        function resetOtherInputs(element) {
            // Ensure we can iterate the radio group safely
            const radioGroup = Array.from(document.getElementsByName(element.name));
            radioGroup.forEach(radio => {
                if (radio === element) return;
                const otherInput = radio.parentElement.querySelector('input[type="text"], input[type="number"]');
                if (otherInput) otherInput.value = '';
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('capForm');
            const reportList = document.getElementById('synopticList');
            const inputs = form.querySelectorAll('input');

            function calculatePN() {
                const metaInput = document.getElementById('ln_meta');
                const positiveNodes = parseInt(metaInput.value);
                const tumorDepositsInput = document.getElementsByName('TumorDepositsNum')[0];
                const tumorDepositsNum = parseInt(tumorDepositsInput && tumorDepositsInput.value) || 0;

                if (!isNaN(positiveNodes)) {
                    document.getElementById('ln_ratio_radio').checked = true;
                }

                let targetId = "";
                if (positiveNodes === 0) {
                    targetId = tumorDepositsNum === 0 ? "pN0" : "pN1c";
                } else if (positiveNodes === 1) {
                    targetId = "pN1a";
                } else if (positiveNodes >= 2 && positiveNodes <= 3) {
                    targetId = "pN1b";
                } else if (positiveNodes >= 4 && positiveNodes <= 6) {
                    targetId = "pN2a";
                } else if (positiveNodes >= 7) {
                    targetId = "pN2b";
                }

                if (targetId) {
                    const radioToSelect = document.getElementById(targetId);
                    if (radioToSelect) radioToSelect.checked = true;
                }
            }

            function updateReport() {
                reportList.innerHTML = '';
                const data = {};

                inputs.forEach(input => {
                    const label = input.getAttribute('data-label');
                    if (!label) return;

                    if (input.type === 'radio' && input.checked) {
                        if (!data[label]) data[label] = [];
                        let val = input.value;
                        const hasText = input.classList.contains('has-text') || input.parentElement.classList.contains('has-text');
                        if (hasText) {
                            const textInput = input.parentElement.querySelector('input[type="text"], input[type="number"]');
                            const textValue = textInput ? textInput.value.trim() : "";
                            if (label === "Margin Status" && val === "Invasive carcinoma present at margin") {
                                val = textValue ? `Present of tumor at ${textValue} margin` : val;
                            } else if (textValue) {
                                val = (val.toLowerCase() === 'other') ? textValue : `${val}: ${textValue}`;
                            }
                        }
                        data[label].unshift(val);
                    } else if (input.type === 'checkbox' && input.checked) {
                        if (!data[label]) data[label] = [];
                        if (input.name === 'Specimen') {
                            if (input.value === 'Other') {
                                const otherValElem = document.querySelector('input[name="organ-other"]');
                                const otherVal = otherValElem ? otherValElem.value.trim() : '';
                                if (otherVal) data[label].push(otherVal);
                            } else {
                                data[label].push(input.value);
                            }
                        } else {
                            data[label].push(input.value);
                        }
                    }
                });

                // Special Ratio Logic
                const metaInput = document.getElementById('ln_meta');
                const totalInput = document.getElementById('ln_total');
                const ratioRadio = document.getElementById('ln_ratio_radio');
                if (ratioRadio && ratioRadio.checked) {
                    const pos = metaInput ? (metaInput.value || "0") : "0";
                    const tot = totalInput ? (totalInput.value || "0") : "0";
                    data["Lymph node metastasis"] = `${pos}/${tot}`;
                }

                // Other standalone text/number inputs
                inputs.forEach(input => {
                    if ((input.type === 'text' || input.type === 'number') &&
                        !input.classList.contains('has-text') &&
                        !input.parentElement.classList.contains('has-text') &&
                        input.id !== 'ln_meta' && input.id !== 'ln_total' &&
                        input.name !== 'organ-other' && input.name !== 'Histology_Other') {

                        const label = input.getAttribute('data-label');
                        if (input.value && label) {
                            data[label] = input.value;
                        }
                    }
                });

                // Construct output
                if (data['Specimen']) {
                    const items = data['Specimen'].map(i => i.toLowerCase());
                    let sentence = (items.length === 1) ? items[0] :
                        (items.length === 2) ? items.join(' and ') :
                        items.slice(0, -1).join(', ') + ', and ' + items.slice(-1);
                    sentence = sentence.charAt(0).toUpperCase() + sentence.slice(1);
                    const headerLi = document.createElement('li');
                    headerLi.className = 'synoptic-item';
                    headerLi.style.listStyleType = 'none';
                    headerLi.innerHTML = `${sentence}, resection:`;
                    reportList.appendChild(headerLi);
                    delete data['Specimen'];
                }

                if (Object.keys(data).length === 0 && reportList.childNodes.length === 0) {
                    reportList.innerHTML = '<li class="synoptic-item">No data selected.</li>';
                } else {
                    for (const [key, value] of Object.entries(data)) {
                        const li = document.createElement('li');
                        li.className = 'synoptic-item';
                        let displayValue = Array.isArray(value) ? value.join(', ') : value;
                        li.innerHTML = `<strong>${key}:</strong> ${displayValue}`;
                        reportList.appendChild(li);
                    }
                }
            }

            // Event listeners
            inputs.forEach(input => {
                input.addEventListener('change', updateReport);
                input.addEventListener('input', () => {
                    if (input.id === 'ln_meta' || input.name === 'TumorDepositsNum') {
                        calculatePN();
                    }
                    updateReport();
                });
            });

            // Initial render
            updateReport();
        });
    </script>
</body>
</html>